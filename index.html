<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jornada de Trabalho</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const sb = supabase.createClient(
  "https://qivhnebuhdponvtplram.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmhuZWJ1aGRwb252dHBscmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM4NTYzMjQsImV4cCI6MjA0OTQzMjMyNH0.2Dmp8BvqWgcUmMg9StRoAdbEvAUrm4yvW8jgc4J-F1M"
);

function getParams() {
  const p = new URLSearchParams(window.location.search);
  return { empresa: p.get("id_empresa"), jornada: p.get("id_jornada") };
}

async function loadData() {

  const p = getParams();
  if (!p.empresa || !p.jornada) return alert("Par칙metros inv치lidos");

  // JORNADA_RESPOSTA
  const { data: jornada } = await sb
    .from("jornada_trabalho_resposta")
    .select("*").eq("id_empresa", p.empresa).eq("id", p.jornada).maybeSingle();

  if (!jornada) return alert("Jornada n칚o encontrada");
  fillJornada(jornada);

  // MOTORISTA
  if (jornada.id_motorista) {
    const { data: motorista } = await sb
      .from("usuarios_empresa")
      .select("*").eq("empresa", p.empresa).eq("id", jornada.id_motorista).maybeSingle();
    if (motorista) fillMotorista(motorista);
  }

  // VIAGEM + C치lculo de KM
  if (jornada.id_viagem) {
    const { data: viagem } = await sb
      .from("viagens").select("*").eq("id", jornada.id_viagem).maybeSingle();
    if (viagem) fillViagem(viagem);
  }

  // DESPESAS
  const { data: despesas } = await sb
    .from("despesas").select("*").eq("id_jornada_resposta", jornada.id);
  if (despesas?.length) fillDespesas(despesas);

  // JORNADA_TRABALHO
  if (jornada.id_jornada_trabalho) {
    const { data: jextra } = await sb
      .from("jornada_trabalho").select("*").eq("id", jornada.id_jornada_trabalho).maybeSingle();
    if (jextra) fillJornadaExtra(jextra);
  }
}

function fillJornada(d) {
  document.getElementById("placa").textContent = d.placa_veiculo || "-";
  document.getElementById("data").textContent = formatDate(d.created_at);
  document.getElementById("inicio").textContent = formatDateTime(d.inicio_data);
  document.getElementById("fim").textContent = formatDateTime(d.fim_data);
  document.getElementById("horas").textContent = convertMinutes(d.total_minutos);
  document.getElementById("cliente").textContent = d.cliente || "-";
  document.getElementById("assinatura").src = d.assinatura_motorista || "https://i.imgur.com/kEPcXkT.png";
}

function fillMotorista(m) {
  if (m.nome) document.getElementById("motorista").textContent = m.nome;
  if (m.assinatura_digital && m.assinatura_digital !== "-")
    document.getElementById("assinatura").src = m.assinatura_digital;
}

function fillViagem(v) {
  if (v.destino) document.getElementById("cidade").textContent = v.destino;

  // 游댝 C치lculo KM
  const km = (parseFloat(v.km_final) || 0) - (parseFloat(v.km_inicial) || 0);
  document.getElementById("km").textContent = km >= 0 ? km + " km" : "-";
}

function fillJornadaExtra(j) {
  if (j.titulo) document.getElementById("rota").textContent = j.titulo;
}

function fillDespesas(list) {
  document.querySelector("#tabela-despesas tbody").innerHTML = list
    .map(d => `<tr>
      <td>${d.tipo || "-"}</td>
      <td>${d.total_litros || "-"}</td>
      <td>${d.valor_litro || "-"}</td>
      <td>${d.valor_total || "-"}</td>
      <td>${d.local || "-"}</td>
    </tr>`).join("");
}

function formatDate(date){return date?new Date(date).toLocaleDateString("pt-BR"):"-";}
function formatDateTime(date){return date?new Date(date).toLocaleString("pt-BR"):"-";}
function convertMinutes(min){if(!min)return"-";const h=Math.floor(min/60),m=min%60;return`${h}h ${m}m`;}
</script>
</head>

<body onload="loadData()">
