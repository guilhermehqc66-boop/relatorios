<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jornada de Trabalho</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 20px;
    }
    .container {
        width: 95%;
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 20px 25px;
        border-radius: 8px;
        box-shadow: 0 0 10px #00000015;
    }
    .logo {
        width: 150px;
        display: block;
        margin: 10px auto 20px auto;
    }
    h1 {
        font-size: 26px;
        margin-bottom: 10px;
        text-align: left;
        font-weight: 700;
    }
    .section-title {
        background: #d9d9d9;
        padding: 6px 10px;
        font-weight: bold;
        margin-top: 20px;
        border-radius: 4px;
    }
    .row {
        display: flex;
        width: 100%;
        margin-bottom: 4px;
    }
    .cell {
        border: 1px solid #cccccc;
        padding: 6px 8px;
        font-size: 14px;
        flex: 1;
    }
    .signature-area {
        margin-top: 40px;
        display: flex;
        justify-content: space-between;
        text-align: center;
    }
    .signature-box {
        width: 45%;
    }
    .signature-img {
        width: 250px;
        height: auto;
        margin-bottom: 5px;
    }
    #debugBox {
        background: #fff3cd;
        border-left: 6px solid #ffcc00;
        padding: 12px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
    }
    #indicador-viagem {
        background: #0075ff;
        color: white;
        padding: 5px 10px;
        display: none;
        font-size: 14px;
        border-radius: 4px;
        margin: 10px 0;
    }
    @media print {
        body { background: white; }
        .container { box-shadow: none; width: 100%; }
        #indicador-viagem, #debugBox { display: none; }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

    const SUPABASE_URL = "https://qivhnebuhdponvtplram.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmhuZWJ1aGRwb252dHBscmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM4NTYzMjQsImV4cCI6MjA0OTQzMjMyNH0.2Dmp8BvqWgcUmMg9StRoAdbEvAUrm4yvW8jgc4J-F1M";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function showIndicadorViagem() {
        document.getElementById("indicador-viagem").style.display = "inline-block";
    }

    function getParams() {
        const p = new URLSearchParams(window.location.search);
        return {
            empresa: p.get("id_empresa"),
            jornada: p.get("id_jornada")
        };
    }

    async function loadData() {
        const p = getParams();

        if (!p.empresa || !p.jornada) {
            alert("Par√¢metros inv√°lidos. Esperado: ?id_empresa=...&id_jornada=...");
            return;
        }

        // üîπ Buscar jornada
        const { data: jornada, error: jornadaError } = await sb
            .from("jornada_trabalho_resposta")
            .select("*")
            .eq("id_empresa", p.empresa)
            .eq("id", p.jornada)
            .limit(1)
            .maybeSingle();

        if (jornadaError || !jornada) {
            alert("Erro ao buscar jornada ou jornada n√£o encontrada.");
            return;
        }

        fillJornada(jornada);

        // üîπ Buscar viagem usando id_viagem
        if (jornada.id_viagem) {
            const { data: viagem, error: viagemError } = await sb
                .from("viagens")
                .select("*")
                .eq("id", jornada.id_viagem)
                .limit(1)
                .maybeSingle();

            if (!viagemError && viagem) {
                fillViagem(viagem);
                showIndicadorViagem();
            }
        }
    }

    // üßæ Preencher JORNADA
    function fillJornada(d) {
        document.getElementById("placa").textContent = d.placa_veiculo || "-";
        document.getElementById("modelo").textContent = d.id_veiculo || "-";
        document.getElementById("km").textContent = d.tacografo || "-";
        document.getElementById("rota").textContent = d.localicacao || "-";
        document.getElementById("cidade").textContent = d.cidade || "-";
        document.getElementById("data").textContent = formatDate(d.created_at);
        document.getElementById("motorista").textContent = d.nome_motorista || "-";
        document.getElementById("inicio").textContent = formatDateTime(d.inicio_data);
        document.getElementById("fim").textContent = formatDateTime(d.fim_data);
        document.getElementById("horas").textContent = convertMinutes(d.total_minutos);
        document.getElementById("cliente").textContent = d.cliente || "-";
        document.getElementById("assinatura").src =
            d.assinatura_motorista || "https://i.imgur.com/kEPcXkT.png";
    }

    // üöö Preencher VIAGEM (AGORA TAMB√âM CIDADE DESTINO)
    function fillViagem(v) {
        if (v.origem) document.getElementById("rota").textContent = `${v.origem} ‚Üí ${v.destino}`;
        if (v.destino) document.getElementById("cidade").textContent = v.destino;
        if (v.tacografo_inicio && v.tacografo_final)
            document.getElementById("km").textContent = `${v.tacografo_inicio} ‚Üí ${v.tacografo_final}`;
    }

    function formatDate(date) {
        if (!date) return "-";
        return new Date(date).toLocaleDateString("pt-BR");
    }

    function formatDateTime(date) {
        if (!date) return "-";
        return new Date(date).toLocaleString("pt-BR");
    }

    function convertMinutes(min) {
        if (!min) return "-";
        const h = Math.floor(min / 60);
        const m = Math.floor(min % 60);
        return `${h}h ${m}m`;
    }

</script>
</head>

<body onload="loadData()">

<div id="debugBox"></div>

<div class="container">

    <img class="logo" src="https://i.imgur.com/f9G8zE7.png" alt="Logo">

    <h1>Jornada de Trabalho</h1>

    <div id="indicador-viagem">üìå Dados da tabela VIAGENS foram carregados</div>

    <div class="section-title">1 - DADOS DOS VE√çCULOS</div>

    <div class="row">
        <div class="cell"><strong>Placa do Ve√≠culo:</strong> <span id="placa"></span></div>
        <div class="cell"><strong>Marca/Modelo:</strong> <span id="modelo"></span></div>
        <div class="cell"><strong>KM do Ve√≠culo:</strong> <span id="km"></span></div>
    </div>

    <div class="row">
        <div class="cell"><strong>Rota:</strong> <span id="rota"></span></div>
        <div class="cell"><strong>Cidade:</strong> <span id="cidade"></span></div>
        <div class="cell"><strong>Data:</strong> <span id="data"></span></div>
    </div>

    <div class="row">
        <div class="cell"><strong>Motorista:</strong> <span id="motorista"></span></div>
    </div>

    <div class="section-title">2 - DADOS DE HORAS</div>

    <div class="row">
        <div class="cell"><strong>In√≠cio Jornada:</strong> <span id="inicio"></span></div>
        <div class="cell"><strong>Fim Jornada:</strong> <span id="fim"></span></div>
        <div class="cell"><strong>Horas Trabalhadas:</strong> <span id="horas"></span></div>
    </div>

    <div class="row">
        <div class="cell"><strong>Cliente:</strong> <span id="cliente"></span></div>
    </div>

    <div class="section-title">3 - ASSINATURA</div>

    <img id="assinatura" class="signature-img" src="" alt="Assinatura">

    <div class="signature-area">
        <div class="signature-box">Assinatura do Motorista:</div>
        <div class="signature-box">Assinatura de Aprova√ß√£o:</div>
    </div>

</div>

</body>
</html>
